name: Check Global Prod Environment Reviewers

on:
  workflow_dispatch:
    inputs:
      REPOS:
        description: 'Comma-separated list of repositories to check'
        required: true
        default: 'Reviewer_test_repo2,Reviewer_test_repo1,GithubAction-Prac'

jobs:
  check-reviewers:
    runs-on: ubuntu-latest

    steps:
      - name: Validate environment reviewers across multiple repos
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          ENV_NAME: global-prod
          ALLOWED_REVIEWERS: "arjunsahi-rs"
          REPOS_LIST: ${{ github.event.inputs.REPOS }}
        run: |
          echo "Starting validation for multiple repositories..."
          # Split comma-separated list into array
          IFS=',' read -ra REPOS <<< "$REPOS_LIST"

          INVALID_FOUND_OVERALL=false

          for REPO in "${REPOS[@]}"; do
            echo "-----------------------------------------"
            echo "Checking repo: $REPO"

            RESPONSE=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$OWNER/$REPO/environments/$ENV_NAME")

            # Single-line jq command to extract reviewers
            REVIEWERS=$(echo "$RESPONSE" | jq -r '.protection_rules[]? | select(.type=="required_reviewers") | .reviewers[]?.reviewer.login')

            if [ -z "$REVIEWERS" ]; then
              echo "❌ No reviewers configured for environment $ENV_NAME in $REPO"
              INVALID_FOUND_OVERALL=true
              continue
            fi

            echo "Configured reviewers in $REPO:"
            echo "$REVIEWERS"

            IFS=',' read -ra ALLOWED <<< "$ALLOWED_REVIEWERS"
            INVALID_FOUND=false

            for reviewer in $REVIEWERS; do
              if [[ ! " ${ALLOWED[*]} " =~ " ${reviewer} " ]]; then
                echo "❌ Unauthorized reviewer found in $REPO: $reviewer"
                INVALID_FOUND=true
                INVALID_FOUND_OVERALL=true
              fi
            done

            if [ "$INVALID_FOUND" = true ]; then
              echo "❌ Environment reviewer validation failed for $REPO"
            else
              echo "✅ Environment reviewers are valid for $REPO"
            fi

          done  # <-- Make sure for loop is closed

          echo "-----------------------------------------"

          if [ "$INVALID_FOUND_OVERALL" = true ]; then
            echo "❌ One or more repositories failed reviewer validation"
            exit 1
          else
            echo "✅ All repositories passed reviewer validation"
          fi
